#!/usr/bin/env python3
import sys
import socket
import requests.packages.urllib3.util.connection as urllib3_cn
from requests import get
from requests.exceptions import RequestException

configurations = {
{% for k, v in telegram.items() %}
    "{{k}}": ("{{v ['token']}}", {{v['chat_id']}}),
{% endfor -%}
}

try:
    config = sys.argv[2]
except IndexError:
    config = "default"

try:
    message = sys.argv[1]
except IndexError:
    sys.stderr.write("No message specified\n")
    sys.exit(2)

try:
    token, chat_id = configurations[config]
except KeyError:
    sys.stderr.write(f"Configuration {config} not found, try {', '.join(configurations.keys())}\n")
    sys.exit(3)

#urllib3_cn.allowed_gai_family = lambda: socket.AF_INET  # Force IPv4
try:
    r = get(f"https://api.telegram.org/bot{token}/sendMessage",
            data={"chat_id": chat_id,
                  "parse_mode": "Markdown",
                  "disable_web_page_preview": True,
                  "text": message})
    r.raise_for_status()
except RequestException as e:
    sys.stderr.write(f"Cannot send message: {e}\n")
    sys.exit(1)
