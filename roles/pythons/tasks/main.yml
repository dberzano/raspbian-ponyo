---
- name: Create base directory for Python venv
  file:
    path: /opt/python/globalvenv
    state: directory
    mode: "0755"
  tags:
    - python

- name: Check if Python virtual environment exists
  stat:
    path: /opt/python/globalvenv/bin/activate
  register: stat_pythonglobalvenv
  tags:
    - python

- name: Create Python global venv
  when: not stat_pythonglobalvenv.stat.exists
  command:
    argv:
      - "python3"
      - "-m"
      - "venv"
      - "/opt/python/globalvenv"
  tags:
    - python

- name: Copy venv script in place
  copy:
    src: pythonglobalvenv.sh
    dest: /opt/python/globalvenv/bin/pythonglobalvenv.sh
    owner: root
    mode: "0755"
  tags:
    - python

- name: Create base directory for Telegram secrets
  file:
    path: /opt/telegramsecrets
    state: directory
    mode: "0755"
  tags:
    - python

- name: Secrets for Telegram bots
  copy:
    content: "{{ telegram_bots[item] }}"
    dest: /opt/telegramsecrets/{{item}}
    mode: "0444"
  loop: "{{ telegram_bots.keys() }}"
  tags:
    - python

- name: Copy requirements
  copy:
    src: requirements.txt
    dest: /opt/python/globalvenv/requirements.txt
    owner: root
    mode: "0644"
  register: copy_requirements
  tags:
    - python

- name: Install pip dependencies
  when: copy_requirements.changed
  command:
    argv:
      - /opt/python/globalvenv/bin/pythonglobalvenv.sh
      - "-m"
      - pip
      - install
      - "-r"
      - /opt/python/globalvenv/requirements.txt
  tags:
    - python

- name: Copy Python scripts in place
  copy:
    src: "{{item}}"
    dest: /usr/local/bin/
    owner: root
    mode: "0755"
  with_fileglob:
    - "files/*.py"
  tags:
    - python
  register: copied_python_scripts

# - name: Print debug copied files
#   debug:
#     var: copied_python_scripts
#   tags:
#     - python

# Some Python scripts require systemd stuff

- name: Create systemd service unit file
  copy:
    src: vpnbox-telegram.service
    dest: /etc/systemd/system/vpnbox-telegram.service
  notify:
    - Reload systemd
  tags:
    - python

- name: Start and enable the service
  systemd:
    name: vpnbox-telegram
    state: started
    enabled: yes
  tags:
    - python

- name: Restart the service if vpnbox-telegram.py has changed
  systemd:
    name: vpnbox-telegram
    state: restarted
  when: >
    copied_python_scripts.results | selectattr("changed", "equalto", true) | map(attribute="item") | map("basename") | list | length > 0
  tags:
    - python